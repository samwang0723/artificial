let activeDiv=null,currentMsg="",currentImage="",refreshBottom=!0,currentVendor="openai",hasIndexDB=!1;function startLoading(){document.getElementById("button-submit").style.display="none",document.getElementById("loading").style.display="block"}function stopLoading(){document.getElementById("button-submit").style.display="block",document.getElementById("loading").style.display="none"}function linkify(e){var t,r,n,s;return r=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#/%?=~_|!:,.;]*[-A-Z0-9+&@#/%=~_|])/gim,t=e.replace(r,"[$1]($1)"),n=/(^|[^/])(www\.[\S]+(\b|$))/gim,t=t.replace(n,"[$1]($2)"),s=/(([a-zA-Z0-9\-_.])+@[a-zA-Z_]+?(\.[a-zA-Z]{2,6})+)/gim,t=t.replace(s,"[$1](mailto:$1)")}function boldify(e){var t,r;return r=/(Subject:|Summary:|Description:|Sources:|Attachments:|Similarity:|Prompt:)/gim,t=e.replace(r,"___$1___")}function addMessageRow(e){let t=document.createElement("div");if("user"===e){t.classList.add("message-row-right");let r=document.createElement("span");r.classList.add("message-body-right"),activeDiv=r,t.appendChild(r)}else{t.classList.add("message-row");let n=document.createElement("span");n.classList.add("message-sender"),n.innerHTML='<img width="30px" height="30px" src="https://cdn.jsdelivr.net/gh/samwang0723/project-allison@main/project_allison/static/'+e+'.svg">',t.appendChild(n);let s=document.createElement("span");s.classList.add("message-body"),activeDiv=s,t.appendChild(s)}let a=document.createElement("span");a.classList.add("message-tail"),t.appendChild(a);document.getElementById("messages").appendChild(t)}function extractImageUrls(e){let t=e.match(/href=["'][^"']*?\.(png|jpe?g|gif|pdf|asp)(?:\?[^"']*)?["']/g);if(!t)return[];let r=t.map(e=>e.slice(6,-1));return r}function formatMessage(e,t){let r=e.split("```"),n="";for(let s=0;s<r.length;s++){var a=r[s];if(s%2==1){let o=a.split("\n"),i=o.shift().trim(),l=o.join("\n");(""===i||"html"===i||"rust"===i||"python"===i||"javascript"===i||"css"===i||"json"===i||"jsx"===i||"markdown"===i||"typescript"===i||"tsx"===i)&&(l=l.replace(/</g,"&lt;").replace(/>/g,"&gt;"));var c="language-";""!=i&&(c="language-"+i,"typescript"===i&&(c="language-javascript")),n+='<pre class="prettyprint line-numbers language-markup"><code class="'+c+'">'+l+"</code></pre>"}else{var g=linkify(a),d=boldify(g);let u=window.markdownit(),m=u.render(d);n+=m}}var p=[];if(t&&(p=extractImageUrls(n)).length>0){var f="<div class='thumbnails'>";for(let h=0;h<p.length;h++){let v=p[h];v.includes(".pdf")?f+="<div class='thumbnail' data-src='"+v+"' style='background-image:url(https://cdn.jsdelivr.net/gh/samwang0723/project-allison@main/project_allison/static/pdf.png)'></div>":f+="<div class='thumbnail' data-src='"+v+"' style='background-image:url("+v+")'></div>"}f+="</div>",n+=f}if(activeDiv.innerHTML=removeAttachments(n),Prism.highlightAllUnder(activeDiv),refreshBottom){let b=document.getElementById("messages");b.scrollTop=b.scrollHeight}if(t&&p.length>0)for(var y=document.getElementsByClassName("thumbnail"),I=function(){let e=this.getAttribute("data-src");window.open(e,"_blank")},E=0;E<y.length;E++)y[E].addEventListener("click",I,!1)}function removeAttachments(e){let t=e.indexOf("<em><strong>Attachments:</strong></em>"),r=e.indexOf("<div class='thumbnails'>",t);return -1!==t&&-1!==r?e.slice(0,t)+e.slice(r):e}function toggleDarkMode(){document.body.classList.toggle("dark-mode")}function toggleLightMode(){document.body.classList.remove("dark-mode")}function uploadImageToImgur(e){let t=new FormData;t.append("image",e),fetch("https://api.imgur.com/3/image",{method:"POST",headers:{Authorization:"Client-ID 507bd7729a21e71"},body:t}).then(e=>e.json()).then(e=>{if(e.success){console.log("Image uploaded successfully:",e.data.link),currentImage=e.data.link;let t=document.getElementById("thumbnailContainer");t.innerHTML=`
          <img src="${parseThumbnail(e.data.link)}" class='thumbnail' alt='Thumbnail'>
          <button class='delete-btn' onclick='removeImage()'> X </button>
      `}else console.error("Image upload failed:",e)}).catch(e=>{console.error("Error uploading image:",e)})}function removeImage(){let e=document.getElementById("thumbnailContainer");e.innerHTML="",currentImage=""}function parseThumbnail(e){let t=e.lastIndexOf(".");if(-1===t)return e;let r=e.substring(0,t),n=e.substring(t);return r+"l"+n}function storeMessage(e,t){if(!hasIndexDB)return;let r=indexedDB.open("artifical-chat",1);r.onsuccess=function(r){let n=r.target.result,s=n.transaction(["messages"],"readwrite"),a=s.objectStore("messages"),o=a.add({owner:e,content:t,timestamp:new Date});o.onsuccess=function(e){console.log("Message stored successfully")},o.onerror=function(e){console.error("Error storing message: ",e.target.errorCode)}},r.onerror=function(e){console.error("Database error: ",e.target.errorCode)}}function loadMessages(e){if(!hasIndexDB)return;let t=indexedDB.open("artifical-chat",1);t.onsuccess=function(t){let r=t.target.result,n=r.transaction(["messages"],"readonly"),s=n.objectStore("messages"),a=[];s.openCursor().onsuccess=function(t){let r=t.target.result;r?(a.push(r.value),r.continue()):e(a)},s.openCursor().onerror=function(e){console.error("Error loading messages: ",e.target.errorCode)}},t.onerror=function(e){console.error("Database error: ",e.target.errorCode)}}function displayHistoricalMessages(e){e.forEach(function(e){addMessageRow(e.owner),formatMessage(e.content,!0)})}function resetMessagesObjectStore(e="artifical-chat",t="messages"){if(hasIndexDB)return new Promise((r,n)=>{let s=indexedDB.open(e);s.onerror=function(e){console.error("Error opening database:",e.target.error),n("Error opening database")},s.onsuccess=function(e){let s=e.target.result,a=s.transaction([t],"readwrite"),o=a.objectStore(t),i=o.clear();i.onerror=function(e){console.error("Error clearing object store:",e.target.error),n("Error clearing object store")},i.onsuccess=function(){console.log("Object store cleared successfully"),r("Object store cleared successfully")}}})}$(document).ready(function(){if(window.indexedDB){console.log("IndexedDB is supported.");let e=indexedDB.open("artifical-chat",1);e.onupgradeneeded=function(e){let t=e.target.result;t.objectStoreNames.contains("messages")||t.createObjectStore("messages",{keyPath:"id",autoIncrement:!0})},e.onerror=function(e){console.error("Database error: ",e.target.errorCode)},e.onsuccess=function(e){hasIndexDB=!0,console.log("Database opened successfully"),loadMessages(displayHistoricalMessages)}}else console.log("Your browser does not support a stable version of IndexedDB. Some features will not be available.");var t,r=window.location.origin,n=new EventSource(r+"/api/v1/sse");n.onopen=function(){console.log("Connected to the server."),activeDiv=null,currentMsg="",stopLoading()},n.onerror=function(){console.log("Error connecting to the server."),stopLoading()},n.addEventListener("user",function(e){var t=JSON.parse(e.data).message;if("[[stop]]"===t){""!==currentMsg&&formatMessage(currentMsg,!0),storeMessage("allison",currentMsg),activeDiv=null,currentMsg="",stopLoading();return}currentMsg+=t,activeDiv||addMessageRow("allison"),formatMessage(currentMsg,!1)}),n.addEventListener("system",function(e){t=e.data}),$("#chat_form").on("submit",function(e){startLoading(),e.preventDefault();var n=$("#message-textfield").val();if(""===n)return;addMessageRow("user"),formatMessage(n+"\n"+currentImage,!0);var s=new XMLHttpRequest;s.open("POST",r+"/api/v1/send/"+currentVendor,!0),s.setRequestHeader("Content-Type","application/json; charset=UTF-8");var a={uuid:t,message:n};let o=n;""!==currentImage&&(a.image=currentImage,removeImage(),o+="\n"+currentImage),storeMessage("user",o);var i=JSON.stringify(a);s.send(i),$("#message-textfield").val(""),$("#message-textfield").height(26),activeDiv=null,currentMsg=""});let s=document.getElementById("message-textfield");s.addEventListener("keydown",function(e){if("Enter"===e.key&&e.shiftKey){e.preventDefault();let t=this.value;this.value=t+"\n"}}),s.oninput=function(){s.style.height="52px",s.style.height=Math.min(s.scrollHeight,280)+"px"};let a=document.getElementById("messages");a.addEventListener("scroll",function(){refreshBottom=a.scrollTop+a.clientHeight>=a.scrollHeight-60});let o=document.getElementById("vendorSelect");o.addEventListener("change",function(){currentVendor=o.value})});
