let activeDiv=null,currentMsg="",refreshBottom=!0;function startLoading(){document.getElementById("button-submit").style.display="none",document.getElementById("loading").style.display="block"}function stopLoading(){document.getElementById("button-submit").style.display="block",document.getElementById("loading").style.display="none"}function linkify(e){var t,s,n,a;return s=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#/%?=~_|!:,.;]*[-A-Z0-9+&@#/%=~_|])/gim,t=e.replace(s,"[$1]($1)"),n=/(^|[^/])(www\.[\S]+(\b|$))/gim,t=t.replace(n,"[$1]($2)"),a=/(([a-zA-Z0-9\-_.])+@[a-zA-Z_]+?(\.[a-zA-Z]{2,6})+)/gim,t=t.replace(a,"[$1](mailto:$1)")}function boldify(e){var t,s;return s=/(Subject:|Summary:|Description:|Sources:|Attachments:|Similarity:|Prompt:)/gim,t=e.replace(s,"___$1___")}function addMessageRow(e){let t=document.createElement("div");t.classList.add("message-row");let s=document.createElement("span");s.classList.add("message-sender"),s.innerHTML='<img width="50px" height="50px" src="https://cdn.jsdelivr.net/gh/samwang0723/project-allison@main/project_allison/static/'+e+'.svg">',t.appendChild(s);let n=document.createElement("span");n.classList.add("message-body"),activeDiv=n,t.appendChild(n);let a=document.createElement("span");a.classList.add("message-tail"),t.appendChild(a);document.getElementById("messages").appendChild(t)}function extractImageUrls(e){let t=e.match(/href=["'][^"']*?\.(png|jpe?g|gif|pdf|asp)(?:\?[^"']*)?["']/g);if(!t)return[];let s=t.map(e=>e.slice(6,-1));return s}function formatMessage(e,t){let s=e.split("```"),n="";for(let a=0;a<s.length;a++){var i=s[a];if(a%2==1){let l=i.split("\n"),r=l.shift().trim(),o=l.join("\n");(""===r||"html"===r||"rust"===r||"python"===r||"javascript"===r||"css"===r||"json"===r||"jsx"===r||"markdown"===r||"typescript"===r||"tsx"===r)&&(o=o.replace(/</g,"&lt;").replace(/>/g,"&gt;"));var c="language-";""!=r&&(c="language-"+r),n+='<pre class="prettyprint line-numbers language-markup"><code class="'+c+'">'+o+"</code></pre>"}else{var d=linkify(i),g=boldify(d);let m=window.markdownit(),p=m.render(g);n+=p}}var u=[];if(t&&(u=extractImageUrls(n)).length>0){var f="<div class='thumbnails'>";for(let v=0;v<u.length;v++){let h=u[v];h.includes(".pdf")?f+="<div class='thumbnail' data-src='"+h+"' style='background-image:url(https://cdn.jsdelivr.net/gh/samwang0723/project-allison@main/project_allison/static/pdf.png)'></div>":f+="<div class='thumbnail' data-src='"+h+"' style='background-image:url("+h+")'></div>"}f+="</div>",n+=f}if(activeDiv.innerHTML=removeAttachments(n),Prism.highlightAllUnder(activeDiv),refreshBottom){let y=document.getElementById("messages");y.scrollTop=y.scrollHeight}if(t&&u.length>0)for(var b=document.getElementsByClassName("thumbnail"),E=function(){let e=this.getAttribute("data-src");window.open(e,"_blank")},L=0;L<b.length;L++)b[L].addEventListener("click",E,!1)}function removeAttachments(e){let t=e.indexOf("<em><strong>Attachments:</strong></em>"),s=e.indexOf("<div class='thumbnails'>",t);return -1!==t&&-1!==s?e.slice(0,t)+e.slice(s):e}function toggleDarkMode(){document.body.classList.toggle("dark-mode")}function toggleLightMode(){document.body.classList.remove("dark-mode")}$(document).ready(function(){var e,t=window.location.origin,s=new EventSource(t+"/api/v1/sse");s.onopen=function(){console.log("Connected to the server."),activeDiv=null,currentMsg="",stopLoading()},s.onerror=function(){console.log("Error connecting to the server."),stopLoading()},s.addEventListener("user",function(e){var t=JSON.parse(e.data).message;if("[[stop]]"===t){""!==currentMsg&&formatMessage(currentMsg,!0),activeDiv=null,currentMsg="",stopLoading();return}currentMsg+=t,activeDiv||addMessageRow("allison"),formatMessage(currentMsg,!1)}),s.addEventListener("system",function(t){console.log("system: "+t.data),e=t.data}),$("#chat_form").on("submit",function(s){startLoading(),s.preventDefault();var n=$("#message-textfield").val();if(""!==n){addMessageRow("user"),formatMessage(n,!0);var a=new XMLHttpRequest;a.open("POST",t+"/api/v1/send",!0),a.setRequestHeader("Content-Type","application/json; charset=UTF-8");var i=JSON.stringify({uuid:e,message:n});a.send(i),$("#message-textfield").val(""),$("#message-textfield").height(40),activeDiv=null,currentMsg=""}});let n=document.getElementById("message-textfield");n.addEventListener("keydown",function(e){if("Enter"===e.key&&e.shiftKey){e.preventDefault();let t=this.value;this.value=t+"\n"}}),n.oninput=function(){n.style.height="52px",n.style.height=Math.min(n.scrollHeight,400)+"px"};let a=document.getElementById("messages");a.addEventListener("scroll",function(){refreshBottom=a.scrollTop+a.clientHeight>=a.scrollHeight-60})});
