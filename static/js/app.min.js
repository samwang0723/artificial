let activeDiv=null,currentMsg="",currentImage="",refreshBottom=!0,currentVendor="openai";function startLoading(){document.getElementById("button-submit").style.display="none",document.getElementById("loading").style.display="block"}function stopLoading(){document.getElementById("button-submit").style.display="block",document.getElementById("loading").style.display="none"}function linkify(e){var t,n,a,s;return n=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#/%?=~_|!:,.;]*[-A-Z0-9+&@#/%=~_|])/gim,t=e.replace(n,"[$1]($1)"),a=/(^|[^/])(www\.[\S]+(\b|$))/gim,t=t.replace(a,"[$1]($2)"),s=/(([a-zA-Z0-9\-_.])+@[a-zA-Z_]+?(\.[a-zA-Z]{2,6})+)/gim,t=t.replace(s,"[$1](mailto:$1)")}function boldify(e){var t,n;return n=/(Subject:|Summary:|Description:|Sources:|Attachments:|Similarity:|Prompt:)/gim,t=e.replace(n,"___$1___")}function addMessageRow(e){let t=document.createElement("div");t.classList.add("message-row");let n=document.createElement("span");n.classList.add("message-sender"),n.innerHTML='<img width="50px" height="50px" src="https://cdn.jsdelivr.net/gh/samwang0723/project-allison@main/project_allison/static/'+e+'.svg">',t.appendChild(n);let a=document.createElement("span");a.classList.add("message-body"),activeDiv=a,t.appendChild(a);let s=document.createElement("span");s.classList.add("message-tail"),t.appendChild(s);document.getElementById("messages").appendChild(t)}function extractImageUrls(e){console.log(e);let t=e.match(/href=["'][^"']*?\.(png|jpe?g|gif|pdf|asp)(?:\?[^"']*)?["']/g);if(!t)return[];let n=t.map(e=>e.slice(6,-1));return n}function formatMessage(e,t){let n=e.split("```"),a="";for(let s=0;s<n.length;s++){var i=n[s];if(s%2==1){let r=i.split("\n"),l=r.shift().trim(),o=r.join("\n");(""===l||"html"===l||"rust"===l||"python"===l||"javascript"===l||"css"===l||"json"===l||"jsx"===l||"markdown"===l||"typescript"===l||"tsx"===l)&&(o=o.replace(/</g,"&lt;").replace(/>/g,"&gt;"));var c="language-";""!=l&&(c="language-"+l),a+='<pre class="prettyprint line-numbers language-markup"><code class="'+c+'">'+o+"</code></pre>"}else{var g=linkify(i),d=boldify(g);let m=window.markdownit(),u=m.render(d);a+=u}}var p=[];if(t&&(p=extractImageUrls(a)).length>0){var h="<div class='thumbnails'>";for(let f=0;f<p.length;f++){let v=p[f];v.includes(".pdf")?h+="<div class='thumbnail' data-src='"+v+"' style='background-image:url(https://cdn.jsdelivr.net/gh/samwang0723/project-allison@main/project_allison/static/pdf.png)'></div>":h+="<div class='thumbnail' data-src='"+v+"' style='background-image:url("+v+")'></div>"}h+="</div>",a+=h}if(activeDiv.innerHTML=removeAttachments(a),Prism.highlightAllUnder(activeDiv),refreshBottom){let y=document.getElementById("messages");y.scrollTop=y.scrollHeight}if(t&&p.length>0)for(var b=document.getElementsByClassName("thumbnail"),I=function(){let e=this.getAttribute("data-src");window.open(e,"_blank")},E=0;E<b.length;E++)b[E].addEventListener("click",I,!1)}function removeAttachments(e){let t=e.indexOf("<em><strong>Attachments:</strong></em>"),n=e.indexOf("<div class='thumbnails'>",t);return -1!==t&&-1!==n?e.slice(0,t)+e.slice(n):e}function toggleDarkMode(){document.body.classList.toggle("dark-mode")}function toggleLightMode(){document.body.classList.remove("dark-mode")}function uploadImageToImgur(e){let t=new FormData;t.append("image",e),fetch("https://api.imgur.com/3/image",{method:"POST",headers:{Authorization:"Client-ID 507bd7729a21e71"},body:t}).then(e=>e.json()).then(e=>{if(e.success){console.log("Image uploaded successfully:",e.data.link),currentImage=e.data.link;let t=document.getElementById("thumbnailContainer");t.innerHTML=`
          <img src="${parseThumbnail(e.data.link)}" class='thumbnail' alt='Thumbnail'>
          <button class='delete-btn' onclick='removeImage()'> X </button>
      `}else console.error("Image upload failed:",e)}).catch(e=>{console.error("Error uploading image:",e)})}function removeImage(){let e=document.getElementById("thumbnailContainer");e.innerHTML="",currentImage=""}function parseThumbnail(e){let t=e.lastIndexOf(".");if(-1===t)return e;let n=e.substring(0,t),a=e.substring(t);return n+"l"+a}$(document).ready(function(){var e,t=window.location.origin,n=new EventSource(t+"/api/v1/sse");n.onopen=function(){console.log("Connected to the server."),activeDiv=null,currentMsg="",stopLoading()},n.onerror=function(){console.log("Error connecting to the server."),stopLoading()},n.addEventListener("user",function(e){var t=JSON.parse(e.data).message;if("[[stop]]"===t){""!==currentMsg&&formatMessage(currentMsg,!0),activeDiv=null,currentMsg="",stopLoading();return}currentMsg+=t,activeDiv||addMessageRow("allison"),formatMessage(currentMsg,!1)}),n.addEventListener("system",function(t){console.log("system: "+t.data),e=t.data}),$("#chat_form").on("submit",function(n){startLoading(),n.preventDefault();var a=$("#message-textfield").val();if(""!==a){addMessageRow("user"),formatMessage(a+"\n"+currentImage,!0);var s=new XMLHttpRequest;s.open("POST",t+"/api/v1/send/"+currentVendor,!0),s.setRequestHeader("Content-Type","application/json; charset=UTF-8");var i={uuid:e,message:a};""!==currentImage&&(i.image=currentImage,removeImage());var r=JSON.stringify(i);s.send(r),$("#message-textfield").val(""),$("#message-textfield").height(26),activeDiv=null,currentMsg=""}});let a=document.getElementById("message-textfield");a.addEventListener("keydown",function(e){if("Enter"===e.key&&e.shiftKey){e.preventDefault();let t=this.value;this.value=t+"\n"}}),a.oninput=function(){a.style.height="52px",a.style.height=Math.min(a.scrollHeight,280)+"px"};let s=document.getElementById("messages");s.addEventListener("scroll",function(){refreshBottom=s.scrollTop+s.clientHeight>=s.scrollHeight-60});let i=document.getElementById("vendorSelect");i.addEventListener("change",function(){currentVendor=i.value})});
