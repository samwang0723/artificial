let activeDiv=null,currentMsg="",refreshBottom=!0;function startLoading(){document.getElementById("button-submit").style.display="none",document.getElementById("loading").style.display="block"}function stopLoading(){document.getElementById("button-submit").style.display="block",document.getElementById("loading").style.display="none"}function linkify(e){var t,n,s,a;return n=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#/%?=~_|!:,.;]*[-A-Z0-9+&@#/%=~_|])/gim,t=e.replace(n,"[$1]($1)"),s=/(^|[^/])(www\.[\S]+(\b|$))/gim,t=t.replace(s,"[$1]($2)"),a=/(([a-zA-Z0-9\-_.])+@[a-zA-Z_]+?(\.[a-zA-Z]{2,6})+)/gim,t=t.replace(a,"[$1](mailto:$1)")}function boldify(e){var t,n;return n=/(Subject:|Summary:|Description:|Sources:|Attachments:|Similarity:|Prompt:)/gim,t=e.replace(n,"___$1___")}function addMessageRow(e){let t=document.createElement("div");t.classList.add("message-row");let n=document.createElement("span");n.classList.add("message-sender"),n.innerHTML='<img width="50px" height="50px" src="https://cdn.jsdelivr.net/gh/samwang0723/project-allison@main/project_allison/static/'+e+'.svg">',t.appendChild(n);let s=document.createElement("span");s.classList.add("message-body"),activeDiv=s,t.appendChild(s);let a=document.createElement("span");a.classList.add("message-tail"),t.appendChild(a);document.getElementById("messages").appendChild(t)}function extractImageUrls(e){let t=e.match(/href=["'][^"']*?\.(png|jpe?g|gif|pdf|asp)(?:\?[^"']*)?["']/g);if(!t)return[];let n=t.map(e=>e.slice(6,-1));return n}function formatMessage(e,t){let n=e.split("```"),s="";for(let a=0;a<n.length;a++){var i=n[a];if(a%2==1){let l=i.split("\n"),r=l.shift().trim(),o=l.join("\n");(""===r||"html"===r||"rust"===r||"markdown"===r)&&(o=o.replace(/</g,"&lt;").replace(/>/g,"&gt;"));var d="language-";""!=r&&(d="language-"+r),s+='<pre class="prettyprint line-numbers language-markup"><code class="'+d+'">'+o+"</code></pre>"}else{var c=linkify(i),g=boldify(c);let m=window.markdownit(),u=m.render(g);s+=u}}var p=[];if(t&&(p=extractImageUrls(s)).length>0){var f="<div class='thumbnails'>";for(let v=0;v<p.length;v++){let h=p[v];h.includes(".pdf")?f+="<div class='thumbnail' data-src='"+h+"' style='background-image:url(https://cdn.jsdelivr.net/gh/samwang0723/project-allison@main/project_allison/static/pdf.png)'></div>":f+="<div class='thumbnail' data-src='"+h+"' style='background-image:url("+h+")'></div>"}f+="</div>",s+=f}if(activeDiv.innerHTML=removeAttachments(s),Prism.highlightAllUnder(activeDiv),refreshBottom){let y=document.getElementById("messages");y.scrollTop=y.scrollHeight}if(t&&p.length>0)for(var b=document.getElementsByClassName("thumbnail"),E=function(){let e=this.getAttribute("data-src");window.open(e,"_blank")},L=0;L<b.length;L++)b[L].addEventListener("click",E,!1)}function removeAttachments(e){let t=e.indexOf("<em><strong>Attachments:</strong></em>"),n=e.indexOf("<div class='thumbnails'>",t);return -1!==t&&-1!==n?e.slice(0,t)+e.slice(n):e}function toggleDarkMode(){document.body.classList.toggle("dark-mode")}function toggleLightMode(){document.body.classList.remove("dark-mode")}$(document).ready(function(){var e,t=window.location.origin,n=new EventSource(t+"/api/v1/sse");n.onopen=function(){console.log("Connected to the server."),activeDiv=null,currentMsg="",stopLoading()},n.onerror=function(){console.log("Error connecting to the server."),stopLoading()},n.addEventListener("user",function(e){var t=JSON.parse(e.data).message;if("[[stop]]"===t){""!==currentMsg&&formatMessage(currentMsg,!0),activeDiv=null,currentMsg="",stopLoading();return}currentMsg+=t,activeDiv||addMessageRow("allison"),formatMessage(currentMsg,!1)}),n.addEventListener("system",function(t){console.log("system: "+t.data),e=t.data}),$("#chat_form").on("submit",function(n){startLoading(),n.preventDefault();var s=$("#message-textfield").val();if(""!==s){addMessageRow("user"),formatMessage(s,!0);var a=new XMLHttpRequest;a.open("POST",t+"/api/v1/send",!0),a.setRequestHeader("Content-Type","application/json; charset=UTF-8");var i=JSON.stringify({uuid:e,message:s});a.send(i),$("#message-textfield").val(""),$("#message-textfield").height(40),activeDiv=null,currentMsg=""}});let s=document.getElementById("message-textfield");s.addEventListener("keydown",function(e){if("Enter"===e.key&&e.shiftKey){e.preventDefault();let t=this.value;this.value=t+"\n"}}),s.oninput=function(){s.style.height="52px",s.style.height=Math.min(s.scrollHeight,400)+"px"};let a=document.getElementById("messages");a.addEventListener("scroll",function(){refreshBottom=a.scrollTop+a.clientHeight>=a.scrollHeight-60})});
